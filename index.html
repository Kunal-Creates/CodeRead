<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeRead - AI Code Explainer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- PrismJS CSS for Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css">

    <style>
        /* --- Design System & Theming --- */
        :root {
            --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
            --ease-out: cubic-bezier(0, 0, 0.2, 1);
        }

        [data-theme="light"] {
            --bg: #F9F9F9;
            --surface: #FFFFFF;
            --primary-text: #111827;
            --secondary-text: #6B7280;
            --border: #E5E7EB;
            --accent: #2563EB;
            --accent-hover: #1D4ED8;
            --surface-code: #F3F4F6;
            --shadow-color: 220, 220, 220;
            --modal-overlay: rgba(0, 0, 0, 0.4);
            --prism-bg: #f5f2f0;
        }

        [data-theme="dark"] {
            --bg: #111827;
            --surface: #1F2937;
            --primary-text: #F9FAFB;
            --secondary-text: #9CA3AF;
            --border: #374151;
            --accent: #3B82F6;
            --accent-hover: #60A5FA;
            --surface-code: #374151;
            --shadow-color: 0, 0, 0;
            --modal-overlay: rgba(0, 0, 0, 0.6);
            --prism-bg: #2d2d2d;
        }

        /* --- Base & Typography --- */
        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Lexend', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--primary-text);
            margin: 0;
            padding: 2rem 1rem;
            line-height: 1.65;
            transition: background-color 0.3s var(--ease-out), color 0.3s var(--ease-out);
        }

        /* --- Main Container & Layout --- */
        .container { width: 100%; max-width: 1280px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding: 0 1rem; }
        
        .logo h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            color: var(--primary-text);
            position: relative;
            display: inline-block;
        }

        main { display: grid; grid-template-columns: 1fr 1.1fr; gap: 2rem; }
        @media (max-width: 1024px) { main { grid-template-columns: 1fr; } }
        
        .card {
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(var(--shadow-color), 0.05), 0 2px 4px -2px rgba(var(--shadow-color), 0.05);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s var(--ease-out), border-color 0.3s var(--ease-out);
            height: 75vh; /* Fixed height for cards */
        }
        @media (max-width: 768px) { .card { height: auto; min-height: 60vh; } }
        
        /* --- Theme Toggle --- */
        .theme-switch { display: flex; align-items: center; gap: 0.5rem; }
        .theme-switch-toggle { position: relative; display: inline-block; width: 44px; height: 24px; }
        .theme-switch-toggle input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: 0.3s var(--ease-in-out); border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: 0.3s var(--ease-in-out); border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- Input Area with PrismJS --- */
        .input-area { position: relative; display: flex; flex-direction: column; flex-grow: 1; min-height: 0; }
        .code-editor-wrapper { flex-grow: 1; position: relative; border: 1px solid var(--border); border-radius: 0.75rem; overflow: hidden; }
        #code-input {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            padding: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre;
            caret-color: var(--primary-text);
            background: transparent;
            color: transparent;
            border: none;
            resize: none;
            z-index: 1;
        }
        #code-input:focus { outline: none; }
        #highlighting-area {
            position: relative;
            height: 100%;
            overflow: auto;
            background-color: var(--bg);
        }
        #highlighting-area pre { margin: 0; }
        #highlighting-area pre code {
            display: block;
            padding: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            min-height: 100%;
        }

        /* --- File Drop Zone --- */
        .drop-zone { position: absolute; inset: 0; background-color: rgba(var(--surface), 0.9); backdrop-filter: blur(4px); border: 2px dashed var(--border); border-radius: 0.75rem; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: var(--secondary-text); transition: all 0.3s var(--ease-in-out); opacity: 0; pointer-events: none; z-index: 10; }
        .drop-zone.visible { opacity: 1; pointer-events: all; }
        .drop-zone.drag-over { border-color: var(--accent); background-color: rgba(var(--accent), 0.05); }
        .drop-zone svg { width: 40px; height: 40px; margin-bottom: 1rem; color: var(--accent); }
        #file-input { display: none; }
        .file-upload-label { color: var(--accent); font-weight: 500; cursor: pointer; text-decoration: none; border-bottom: 1px solid var(--accent); }
        .image-preview { position: absolute; inset: 0; background-color: var(--surface); border-radius: 0.75rem; padding: 1rem; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem; z-index: 11; }
        .image-preview img { max-width: 80%; max-height: 70%; object-fit: contain; border-radius: 0.5rem; border: 1px solid var(--border); }
        .image-preview-text { font-weight: 500; font-size: 0.9rem; color: var(--secondary-text); }

        /* --- Action Bar & Buttons --- */
        .action-bar { margin-top: 1.5rem; display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; }
        .action-button { background-color: var(--surface); color: var(--primary-text); border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.75rem; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s var(--ease-out); display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .action-button:hover:not(:disabled) { background-color: var(--bg); border-color: var(--secondary-text); }
        .action-button.primary { background-color: var(--accent); color: white; border-color: var(--accent); }
        .action-button.primary:hover:not(:disabled) { background-color: var(--accent-hover); border-color: var(--accent-hover); }
        .action-button:disabled { opacity: 0.6; cursor: not-allowed; }
        .action-button svg { width: 18px; height: 18px; }

        /* --- Output Area --- */
        .output-area { flex-grow: 1; overflow-y: auto; min-height: 0; }
        .placeholder, .loader { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; text-align: center; color: var(--secondary-text); }
        .placeholder svg, .loader svg { width: 48px; height: 48px; margin-bottom: 1rem; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-left-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-message { background-color: #FFF1F2; color: #DC2626; border: 1px solid #FCA5A5; border-radius: 0.5rem; padding: 1rem; text-align: center; }
        [data-theme="dark"] .error-message { background-color: #450a0a; color: #FCA5A5; border-color: #7f1d1d; }

        /* --- Parsed Markdown Styling --- */
        .analysis-content h3 { font-size: 1.125rem; font-weight: 600; margin-top: 2.5rem; margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border); }
        .analysis-content h3:first-child { margin-top: 0; }
        .analysis-content h3 svg { width: 20px; height: 20px; color: var(--accent); flex-shrink: 0; }
        .analysis-content p { margin-bottom: 1rem; }
        .analysis-content ul { list-style: none; padding-left: 0; margin-bottom: 1rem; }
        .analysis-content li { display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem; }
        .analysis-content li::before { content: 'âœ“'; color: var(--accent); font-weight: 600; margin-top: 2px; }
        .analysis-content .code-wrapper { background-color: var(--surface-code); border: 1px solid var(--border); border-radius: 0.75rem; margin: 1.5rem 0; }
        .analysis-content .code-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; background-color: var(--bg); border-bottom: 1px solid var(--border); border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem; }
        .analysis-content .code-header .lang { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--secondary-text); }
        .analysis-content .copy-btn { background: none; border: 1px solid var(--border); color: var(--secondary-text); padding: 0.25rem 0.5rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 0.25rem; }
        .analysis-content code { font-family: 'JetBrains Mono', monospace; background-color: var(--surface-code); border-radius: 4px; padding: 0.2em 0.4em; font-size: 85%; color: var(--primary-text); }
        .analysis-content pre { background-color: transparent; margin: 0; padding: 1rem; overflow-x: auto; font-size: 0.9rem; }
        .analysis-content pre code { background-color: transparent; padding: 0; color: inherit; }
        .analysis-content strong { font-weight: 600; color: var(--primary-text); }
        .analysis-content .analogy { font-style: italic; color: var(--secondary-text); border-left: 3px solid var(--accent); padding-left: 1rem; margin: 1.5rem 0; }

        /* --- Modal Styling --- */
        .modal-overlay { position: fixed; inset: 0; background-color: var(--modal-overlay); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s var(--ease-in-out); }
        .modal-overlay.visible { opacity: 1; pointer-events: all; }
        .modal { background-color: var(--surface); border-radius: 1rem; padding: 2rem; width: 90%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); transform: scale(0.95); transition: transform 0.3s var(--ease-in-out); }
        .modal-overlay.visible .modal { transform: scale(1); }
        .modal h2 { margin-top: 0; font-size: 1.5rem; }
        .modal select { width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border); background-color: var(--bg); color: var(--primary-text); font-size: 1rem; margin-top: 1rem; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem; }
        .modal-button { padding: 0.625rem 1.25rem; border-radius: 0.5rem; border: 1px solid var(--border); background-color: var(--surface); cursor: pointer; font-weight: 600; }
        .modal-button.primary { background-color: var(--accent); color: white; border-color: var(--accent); }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="logo">
                <h1 id="logo-text">CodeRead</h1>
            </div>
            <div class="theme-switch">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
                <label class="theme-switch-toggle">
                    <input type="checkbox" id="theme-toggle-checkbox">
                    <span class="slider"></span>
                </label>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </div>
        </header>

        <main>
            <!-- Input Card -->
            <div class="card">
                <div class="input-area">
                    <div class="code-editor-wrapper">
                        <textarea id="code-input" spellcheck="false" placeholder="Paste your code here..."></textarea>
                        <div id="highlighting-area">
                            <pre><code id="highlighting-code" class="language-js"></code></pre>
                        </div>
                    </div>
                    <div id="drop-zone" class="drop-zone">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        <strong>Drop an image of your code</strong>
                        <p>or <label for="file-input" class="file-upload-label">browse files</label></p>
                    </div>
                    <div id="image-preview" class="image-preview" style="display: none;">
                        <img id="preview-img" src="" alt="Code snippet preview"/>
                        <p class="image-preview-text" id="preview-text"></p>
                    </div>
                </div>
                <input type="file" id="file-input" accept="image/*">
                <div class="action-bar">
                    <button id="analyze-button" class="action-button primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 3a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3H6a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3h12a3 3 0 0 0 3-3 3 3 0 0 0-3-3z"/></svg>
                        <span>Analyze</span>
                    </button>
                    <button id="convert-button" class="action-button">
                        <span>Convert</span>
                    </button>
                    <button id="test-button" class="action-button">
                        <span>Generate Tests</span>
                    </button>
                </div>
            </div>

            <!-- Output Card -->
            <div class="card">
                <div id="output-area" class="output-area">
                    <div id="output-placeholder" class="placeholder">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10c0-2.34-.84-4.51-2.27-6.22"/><path d="M15.5 6.26A10 10 0 0 0 6.26 15.5"/><path d="M12 18a6 6 0 0 0 6-6"/><path d="M12 12a2 2 0 0 0 2-2"/></svg>
                        <p>Your code's story will appear here.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Conversion Modal -->
    <div id="modal-overlay" class="modal-overlay">
        <div id="modal" class="modal">
            <h2>Convert Code</h2>
            <p>Select the target language to convert your code to.</p>
            <select id="language-select">
                <option>JavaScript</option>
                <option>Python</option>
                <option>Java</option>
                <option>C++</option>
                <option>C#</option>
                <option>TypeScript</option>
                <option>Go</option>
                <option>Rust</option>
                <option>PHP</option>
                <option>Ruby</option>
            </select>
            <div class="modal-actions">
                <button id="modal-cancel" class="modal-button">Cancel</button>
                <button id="modal-confirm" class="modal-button primary">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- PrismJS JS for Syntax Highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <script type="module">
        // --- DOM Elements ---
        const codeInput = document.getElementById('code-input');
        const highlightingCode = document.getElementById('highlighting-code');
        const highlightingArea = document.getElementById('highlighting-area');
        const analyzeButton = document.getElementById('analyze-button');
        const convertButton = document.getElementById('convert-button');
        const testButton = document.getElementById('test-button');
        const outputArea = document.getElementById('output-area');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const imagePreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const previewText = document.getElementById('preview-text');
        const themeToggle = document.getElementById('theme-toggle-checkbox');
        const htmlEl = document.documentElement;
        const modalOverlay = document.getElementById('modal-overlay');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');
        const languageSelect = document.getElementById('language-select');

        // --- State ---
        let isLoading = false;
        let currentAnalysisType = 'text';
        let imageBase64 = null;
        
        // IMPORTANT: Add your Gemini API Key here to run locally
        const USER_API_KEY = "AIzaSyCFrT0Gf0hHWisY_AQPLyV8FJO20ghQPt8"; // <--- PASTE YOUR API KEY HERE

        // --- Icon Definitions ---
        const icons = {
            Story: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>`,
            Logic: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-4"/><path d="M12 10V4"/><path d="M12 16a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-2z"/><path d="M20 12h-4"/><path d="M8 12H4"/></svg>`,
            Issues: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
            Improvements: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v18M21.2 12.8H2.8"/><path d="m3 9 9-7 9 7"/><path d="m3 15 9 7 9-7"/></svg>`,
            Tests: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>`,
            Conversion: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="8 21 3 21 3 16"/><line x1="20" y1="4" x2="3" y2="21"/></svg>`
        };

        // --- Theme Logic ---
        const applyTheme = (theme) => {
            htmlEl.setAttribute('data-theme', theme);
            themeToggle.checked = theme === 'dark';
        };
        const toggleTheme = () => {
            const newTheme = htmlEl.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        };
        themeToggle.addEventListener('change', toggleTheme);
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);

        // --- Syntax Highlighting Logic ---
        const updateHighlighting = () => {
            const code = codeInput.value;
            highlightingCode.textContent = code;
            Prism.highlightElement(highlightingCode);
        };

        const syncScroll = () => {
            highlightingArea.scrollTop = codeInput.scrollTop;
            highlightingArea.scrollLeft = codeInput.scrollLeft;
        };

        codeInput.addEventListener('input', updateHighlighting);
        codeInput.addEventListener('scroll', syncScroll);
        updateHighlighting(); // Initial highlight

        // --- Utility Functions ---
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        const renderLoader = (message) => { outputArea.innerHTML = `<div class="loader"><div class="spinner"></div><p>${message}</p></div>`; };
        const renderError = (message) => { outputArea.innerHTML = `<div class="error-message">${message}</div>`; };
        const renderMarkdown = (markdown) => {
            let html = markdown
                .replace(/### ICON:(\w+)\s(.*)/g, (match, iconKey, title) => {
                    const iconSvg = icons[iconKey] || '';
                    return `<h3>${iconSvg}<span>${title}</span></h3>`;
                })
                .replace(/This code is like (.*)\./g, '<p class="analogy">This code is like $1.</p>')
                .replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
                    const language = lang || 'plaintext';
                    const highlightedCode = Prism.highlight(code, Prism.languages[language] || Prism.languages.clike, language);
                    return `<div class="code-wrapper">
                                <div class="code-header">
                                    <span class="lang">${language}</span>
                                    <button class="copy-btn">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                        Copy
                                    </button>
                                </div>
                                <pre><code class="language-${language}">${highlightedCode}</code></pre>
                            </div>`;
                })
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\n\s*-\s/g, '</li><li>')
                .replace(/<\/li><li>/g, (match, offset) => offset === 0 ? '<ul><li>' : match)
                .replace(/<\/pre>(\s*)<\/li>/g, '</pre></li>')
                .replace(/(\n)/g, '<br>')
                .replace(/<\/li><br>/g, '</li>')
                .replace(/<br><br>/g, '<p>')
                .replace(/<\/li><p>/g, '</li></ul><p>')
                .replace(/<\/div><p>/g, '</div><p>');

            if (html.includes('<li>') && !html.endsWith('</ul>')) {
                html += '</ul>';
            }

            outputArea.innerHTML = `<div class="analysis-content">${html}</div>`;
            
            // Add event listeners to new copy buttons
            outputArea.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const code = btn.closest('.code-wrapper').querySelector('pre code').innerText;
                    navigator.clipboard.writeText(code).then(() => {
                        btn.innerHTML = 'Copied!';
                        setTimeout(() => {
                           btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> Copy`;
                        }, 2000);
                    });
                });
            });
        };

        // --- API Call Logic ---
        const generateWithBackoff = async (payload, loadingMessage) => {
            if (!USER_API_KEY && !window.frameElement) {
                renderError("API Key not found. Please add your Gemini API key in the script to run this locally.");
                return;
            }
            isLoading = true;
            [analyzeButton, convertButton, testButton].forEach(btn => btn.disabled = true);
            renderLoader(loadingMessage);

            let delay = 1000;
            for (let i = 0; i < 3; i++) {
                try {
                    const apiKey = USER_API_KEY; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        renderMarkdown(result.candidates[0].content.parts[0].text);
                        break;
                    } else {
                        throw new Error(`Analysis failed. Reason: ${result.candidates?.[0]?.finishReason || 'No content'}.`);
                    }
                } catch (e) {
                    if (i === 2) {
                        renderError(e.message);
                        break;
                    }
                    await sleep(delay);
                    delay *= 2;
                }
            }
            isLoading = false;
            [analyzeButton, convertButton, testButton].forEach(btn => btn.disabled = false);
        };

        const getBasePayload = () => {
             if (currentAnalysisType === 'image' && imageBase64) {
                return {
                    parts: [
                        { text: "" }, // Placeholder for prompt
                        { inlineData: { mimeType: "image/png", data: imageBase64 } }
                    ]
                };
            } else {
                const code = codeInput.value.trim();
                if (!code) {
                    renderError("Please provide some code to analyze.");
                    return null;
                }
                return { parts: [{ text: `\n\nHere is the code:\n\`\`\`\n${code}\n\`\`\`` }] };
            }
        };

        // --- Event Handlers ---
        analyzeButton.addEventListener('click', () => {
            if (isLoading) return;
            const basePayload = getBasePayload();
            if (!basePayload) return;
            
            const prompt = `You are CodeRead, an AI code analysis expert with a knack for storytelling. Your goal is to make code intuitive and easy to understand. First, identify the programming language of the code snippet. Then, explain the code by framing it as a story or a simple analogy. Structure your response in Markdown with these EXACT sections, using the 'ICON:' prefix: ### ICON:Story The Story of this Code\nStart with the phrase "This code is like a..." and provide a simple, creative analogy. Then, give a high-level summary of its purpose.\n\n### ICON:Logic Step-by-Step Logic\nWalk through the code's logic as if you are the computer executing it. Use bullet points for clarity. Mention the detected programming language. Use **bold** for key terms or variable names.\n\n### ICON:Issues Potential Plot Twists\nPoint out any potential bugs, edge cases, or vulnerabilities. If none, state "The story looks solid, with no unexpected plot twists."\n\n### ICON:Improvements A Better Draft\nSuggest specific, actionable improvements for efficiency, readability, or modern best practices.`;
            basePayload.parts[0].text = prompt + (basePayload.parts[0].text || "");
            generateWithBackoff({ contents: [basePayload] }, 'Unraveling the story...');
        });

        testButton.addEventListener('click', () => {
            if (isLoading) return;
            const basePayload = getBasePayload();
            if (!basePayload) return;

            const prompt = `You are an expert test generation AI. Your task is to write a suite of unit tests for the provided code. First, detect the language and a popular testing framework for it (e.g., Jest for JS/TS, PyTest for Python, JUnit for Java). Then, generate the test code. Structure your response in Markdown with these EXACT sections, using the 'ICON:' prefix: ### ICON:Tests Generating Unit Tests\nState the detected language and the testing framework you've chosen. Briefly explain the purpose of the test suite.\n\n### ICON:Logic Code\nProvide the complete, runnable unit test code inside a single code block.`;
            basePayload.parts[0].text = prompt + (basePayload.parts[0].text || "");
            generateWithBackoff({ contents: [basePayload] }, 'Generating unit tests...');
        });

        convertButton.addEventListener('click', () => {
            if (isLoading) return;
            modalOverlay.classList.add('visible');
        });
        
        modalCancel.addEventListener('click', () => modalOverlay.classList.remove('visible'));
        modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) modalOverlay.classList.remove('visible'); });

        modalConfirm.addEventListener('click', () => {
            modalOverlay.classList.remove('visible');
            const targetLanguage = languageSelect.value;
            const basePayload = getBasePayload();
            if (!basePayload) return;

            const prompt = `You are an expert code conversion AI. Your task is to convert the given code snippet to ${targetLanguage}. Structure your response in Markdown with this EXACT section header, using the 'ICON:' prefix: ### ICON:Conversion Conversion to ${targetLanguage}\nFirst, provide the complete, converted code in ${targetLanguage} inside a single code block. Below the code block, state the detected source language and mention any important caveats or differences.`;
            basePayload.parts[0].text = prompt + (basePayload.parts[0].text || "");
            generateWithBackoff({ contents: [basePayload] }, `Converting to ${targetLanguage}...`);
        });

        // --- Drag and Drop Logic ---
        const body = document.body;
        body.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('visible'); });
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });
        body.addEventListener('dragleave', (e) => { if(!e.relatedTarget || e.relatedTarget.nodeName === 'HTML'){ dropZone.classList.remove('visible'); dropZone.classList.remove('drag-over'); } });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault(); e.stopPropagation();
            dropZone.classList.remove('visible'); dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFile(e.target.files[0]); });
        const handleFile = (file) => {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imageBase64 = e.target.result.split(',')[1];
                    previewImg.src = e.target.result;
                    previewText.textContent = `Ready to analyze: ${file.name}`;
                    imagePreview.style.display = 'flex';
                    currentAnalysisType = 'image';
                    codeInput.disabled = true;
                };
                reader.readAsDataURL(file);
            } else { renderError("Please upload a valid image file."); }
        };
        imagePreview.addEventListener('click', () => {
            imagePreview.style.display = 'none'; previewImg.src = ''; fileInput.value = '';
            imageBase64 = null; currentAnalysisType = 'text'; codeInput.disabled = false;
        });
    </script>
</body>
</html>
